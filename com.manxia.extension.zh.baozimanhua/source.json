{
  "metadata": {
    "id": "com.manxia.extension.zh.baozimanhua",
    "name": "包子漫画",
    "type": "manga",
    "version": "1.0.0",
    "language": "zh-CN",
    "baseUrl": "https://cn.baozimh.com",
    "description": "包子漫画 - 需要科学网络，国漫为主",
    "author": "ManXia Team (移植自 keiyoushi)",
    "nsfw": false,
    "tags": ["chinese", "webview", "free", "popular"],
    "Internet": true
  },

  "capabilities": {
    "urlResolver": true,
    "pagination": true,
    "errorRetry": true,
    "loginSupport": false
  },

  "network": {
    "userAgent": "Mozilla/5.0 (Linux; Android 13; Pixel 7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Mobile Safari/537.36",
    "timeout": 30000,
    "retryCount": 3,
    "retryDelay": 2000,
    "rateLimit": 500
  },

  "_TODO": [
    "1. [镜像切换] 原版支持15个镜像域名切换，需要实现设置页面让用户选择",
    "2. [Banner切除] 原版使用 BaoziBanner 库自动切除图片中的广告横幅，暂不支持",
    "3. [章节顺序修复] 原版有修复章节顺序错误的选项，需要实现设置项",
    "4. [快速页面] 原版有跳过重定向的快速页面功能，需要评估是否需要",
    "5. [Cloudflare绕过] 可能需要处理CF验证，目前依赖WebView自动处理",
    "6. [缺失图片处理] 原版拦截404图片重定向，需要在图片加载失败时处理"
  ],

  "_MIRRORS": [
    "cn.baozimh.com (简体-主站)",
    "tw.baozimh.com (繁体)",
    "www.baozimh.com",
    "cn.webmota.com",
    "tw.webmota.com",
    "www.webmota.com",
    "cn.kukuc.co",
    "tw.kukuc.co",
    "www.kukuc.co",
    "cn.twmanga.com",
    "tw.twmanga.com",
    "www.twmanga.com",
    "cn.dinnerku.com",
    "tw.dinnerku.com",
    "www.dinnerku.com"
  ],

  "workflows": {
    "popular": {
      "description": "获取热门漫画（分类页面）",
      "supportsPagination": true,
      "actions": [
        {
          "type": "navigate",
          "url": "https://cn.baozimh.com/classify?page={{page}}",
          "timeout": 15000,
          "description": "导航到分类页面"
        },
        {
          "type": "wait",
          "condition": "element",
          "selector": "a.comics-card__poster",
          "timeout": 10000,
          "description": "等待漫画卡片加载"
        },
        {
          "type": "script",
          "code": "(() => { const cards = document.querySelectorAll('div.pure-g div a.comics-card__poster'); const currentPage = {{page}} || 1; const hasNextPage = cards.length >= 36; return JSON.stringify({ hasNextPage: hasNextPage, totalItems: cards.length }); })();",
          "description": "检查分页信息（每页36个）"
        },
        {
          "type": "script",
          "code": "(() => { const cards = document.querySelectorAll('div.pure-g div a.comics-card__poster'); const results = []; cards.forEach((card, index) => { const href = card.getAttribute('href') || ''; const title = card.getAttribute('title') || ''; const ampImg = card.querySelector('amp-img'); const cover = ampImg ? (ampImg.getAttribute('src') || '') : ''; results.push({ id: href, title: title, cover: cover }); }); return JSON.stringify(results); })();",
          "description": "提取热门漫画列表"
        }
      ]
    },

    "filter": {
      "description": "筛选漫画（支持标签、地区、进度筛选）",
      "supportsPagination": true,
      "defaults": {
        "type": "all",
        "region": "all",
        "state": "all",
        "filter": "*"
      },
      "actions": [
        {
          "type": "script",
          "code": "(() => { const page = {{page}} || 1; const type = '{{type}}' || 'all'; const region = '{{region}}' || 'all'; const state = '{{state}}' || 'all'; const filter = '{{filter}}' || '*'; let url = 'https://cn.baozimh.com/classify?page=' + page; if (type && type !== 'all') url += '&type=' + type; if (region && region !== 'all') url += '&region=' + region; if (state && state !== 'all') url += '&state=' + state; if (filter && filter !== '*') url += '&filter=' + filter; return url; })();",
          "description": "构建筛选URL"
        },
        {
          "type": "navigate",
          "url": "{{scriptResult}}",
          "timeout": 15000,
          "description": "导航到筛选结果页面"
        },
        {
          "type": "wait",
          "condition": "element",
          "selector": "a.comics-card__poster",
          "timeout": 10000,
          "description": "等待漫画卡片加载"
        },
        {
          "type": "script",
          "code": "(() => { const cards = document.querySelectorAll('div.pure-g div a.comics-card__poster'); const currentPage = {{page}} || 1; const hasNextPage = cards.length >= 36; return JSON.stringify({ hasNextPage: hasNextPage, totalItems: cards.length }); })();",
          "description": "检查分页信息（每页36个）"
        },
        {
          "type": "script",
          "code": "(() => { const cards = document.querySelectorAll('div.pure-g div a.comics-card__poster'); const results = []; cards.forEach((card, index) => { const href = card.getAttribute('href') || ''; const title = card.getAttribute('title') || ''; const ampImg = card.querySelector('amp-img'); const cover = ampImg ? (ampImg.getAttribute('src') || '') : ''; results.push({ id: href, title: title, cover: cover }); }); return JSON.stringify(results); })();",
          "description": "提取筛选结果漫画列表"
        }
      ]
    },

    "latest": {
      "description": "获取最新更新",
      "actions": [
        {
          "type": "navigate",
          "url": "https://cn.baozimh.com/list/new",
          "timeout": 15000,
          "description": "导航到最新更新页"
        },
        {
          "type": "wait",
          "condition": "element",
          "selector": "a.comics-card__poster",
          "timeout": 10000,
          "description": "等待漫画卡片加载"
        },
        {
          "type": "script",
          "code": "(() => { const cards = document.querySelectorAll('div.pure-g div a.comics-card__poster'); const results = []; cards.forEach((card, index) => { const href = card.getAttribute('href') || ''; const title = card.getAttribute('title') || ''; const ampImg = card.querySelector('amp-img'); const cover = ampImg ? (ampImg.getAttribute('src') || '') : ''; results.push({ id: href, title: title, cover: cover }); }); return JSON.stringify(results); })();",
          "description": "提取最新更新漫画"
        }
      ]
    },

    "search": {
      "description": "搜索漫画",
      "supportsPagination": false,
      "actions": [
        {
          "type": "navigate",
          "url": "https://cn.baozimh.com/search?q={{query}}",
          "timeout": 15000,
          "description": "导航到搜索结果页"
        },
        {
          "type": "wait",
          "condition": "element",
          "selector": "a.comics-card__poster",
          "timeout": 10000,
          "description": "等待搜索结果加载"
        },
        {
          "type": "script",
          "code": "(() => { const cards = document.querySelectorAll('div.pure-g div a.comics-card__poster'); const results = []; cards.forEach((card, index) => { const href = card.getAttribute('href') || ''; const title = card.getAttribute('title') || ''; const ampImg = card.querySelector('amp-img'); const cover = ampImg ? (ampImg.getAttribute('src') || '') : ''; results.push({ id: href, title: title, cover: cover }); }); return JSON.stringify(results); })();",
          "description": "提取搜索结果"
        }
      ]
    },

    "getMangaDetail": {
      "description": "获取漫画详情",
      "actions": [
        {
          "type": "navigate",
          "url": "https://cn.baozimh.com/comic/{{mangaId}}",
          "timeout": 15000,
          "description": "导航到漫画详情页"
        },
        {
          "type": "wait",
          "condition": "element",
          "selector": "h1.comics-detail__title",
          "timeout": 10000,
          "description": "等待详情加载"
        },
        {
          "type": "script",
          "code": "(() => { const title = document.querySelector('h1.comics-detail__title')?.textContent?.trim() || ''; const cover = document.querySelector('div.pure-g div > amp-img')?.getAttribute('src')?.trim() || ''; const author = document.querySelector('h2.comics-detail__author')?.textContent?.trim() || ''; const description = document.querySelector('p.comics-detail__desc')?.textContent?.trim() || ''; const statusEl = document.querySelector('div.tag-list > span.tag'); let status = '未知'; if (statusEl) { const statusText = statusEl.textContent.trim(); if (statusText === '连载中' || statusText === '連載中') status = '连载中'; else if (statusText === '已完结' || statusText === '已完結') status = '已完结'; } return JSON.stringify({ title, cover, author, status, description }); })();",
          "description": "提取漫画详情"
        }
      ]
    },

    "getMangaDetailWithChapters": {
      "description": "获取漫画详情和章节列表",
      "actions": [
        {
          "type": "navigate",
          "url": "https://cn.baozimh.com/comic/{{mangaId}}",
          "timeout": 15000,
          "description": "导航到漫画详情页"
        },
        {
          "type": "wait",
          "condition": "element",
          "selector": "h1.comics-detail__title",
          "timeout": 10000,
          "description": "等待详情加载"
        },
        {
          "type": "script",
          "code": "(() => { const title = document.querySelector('h1.comics-detail__title')?.textContent?.trim() || ''; const cover = document.querySelector('div.pure-g div > amp-img')?.getAttribute('src')?.trim() || ''; const author = document.querySelector('h2.comics-detail__author')?.textContent?.trim() || ''; const description = document.querySelector('p.comics-detail__desc')?.textContent?.trim() || ''; const statusEl = document.querySelector('div.tag-list > span.tag'); let status = '未知'; if (statusEl) { const statusText = statusEl.textContent.trim(); if (statusText === '连载中' || statusText === '連載中') status = '连载中'; else if (statusText === '已完结' || statusText === '已完結') status = '已完结'; } return JSON.stringify({ title, cover, author, status, description }); })();",
          "description": "提取漫画详情"
        },
        {
          "type": "script",
          "code": "(() => { const chapters = []; const chapterEls = document.querySelectorAll('.comics-chapters'); const dateEl = document.querySelector('em'); let updateDate = ''; if (dateEl) { const dateText = dateEl.textContent || ''; if (dateText.includes('年')) { updateDate = dateText.replace('(', '').replace(' 更新)', '').replace('（', '').replace(' 更新）', '').trim(); } } chapterEls.forEach((el, index) => { const link = el.querySelector('a'); if (link) { let href = link.getAttribute('href') || ''; const title = link.textContent?.trim() || el.textContent?.trim() || ''; if (href && title) { try { const url = new URL(href, window.location.origin); if (url.pathname.includes('/user/page_direct')) { const comicId = url.searchParams.get('comic_id'); const sectionSlot = url.searchParams.get('section_slot') || '0'; const chapterSlot = url.searchParams.get('chapter_slot') || '0'; href = '/comic/chapter/' + comicId + '/' + sectionSlot + '_' + chapterSlot + '.html'; } } catch (e) { console.log('URL解析失败:', e); } chapters.push({ id: href, title: title, date: index === 0 ? updateDate : '' }); } } }); chapters.reverse(); return JSON.stringify(chapters); })();",
          "description": "提取章节列表（转换为直接章节URL格式）"
        }
      ]
    },

    "getChapterList": {
      "description": "获取章节列表",
      "actions": [
        {
          "type": "navigate",
          "url": "https://cn.baozimh.com/comic/{{mangaId}}",
          "timeout": 15000,
          "description": "导航到漫画详情页"
        },
        {
          "type": "wait",
          "condition": "element",
          "selector": ".comics-chapters",
          "timeout": 10000,
          "description": "等待章节列表加载"
        },
        {
          "type": "script",
          "code": "(() => { const chapters = []; const chapterEls = document.querySelectorAll('.comics-chapters'); const dateEl = document.querySelector('em'); let updateDate = ''; if (dateEl) { const dateText = dateEl.textContent || ''; if (dateText.includes('年')) { updateDate = dateText.replace('(', '').replace(' 更新)', '').replace('（', '').replace(' 更新）', '').trim(); } } chapterEls.forEach((el, index) => { const link = el.querySelector('a'); if (link) { let href = link.getAttribute('href') || ''; const title = link.textContent?.trim() || el.textContent?.trim() || ''; if (href && title) { try { const url = new URL(href, window.location.origin); if (url.pathname.includes('/user/page_direct')) { const comicId = url.searchParams.get('comic_id'); const sectionSlot = url.searchParams.get('section_slot') || '0'; const chapterSlot = url.searchParams.get('chapter_slot') || '0'; href = '/comic/chapter/' + comicId + '/' + sectionSlot + '_' + chapterSlot + '.html'; } } catch (e) { console.log('URL解析失败:', e); } chapters.push({ id: href, title: title, date: index === 0 ? updateDate : '' }); } } }); chapters.reverse(); return JSON.stringify(chapters); })();",
          "description": "提取章节列表（转换为直接章节URL格式）"
        }
      ]
    },

    "getPageList": {
      "description": "获取章节图片列表（使用直接章节URL格式 /comic/chapter/xxx/0_0.html）",
      "_TODO": "原版支持章节内分页，需要循环请求直到没有'下一页'按钮",
      "actions": [
        {
          "type": "navigate",
          "url": "https://cn.baozimh.com{{chapterId}}",
          "timeout": 20000,
          "description": "导航到章节阅读页（直接URL格式，无需重定向）"
        },
        {
          "type": "wait",
          "condition": "element",
          "selector": ".comic-contain amp-img",
          "timeout": 15000,
          "description": "等待图片元素加载"
        },
        {
          "type": "script",
          "code": "(() => { const pages = []; const images = document.querySelectorAll('.comic-contain amp-img'); console.log('[Baozi] 找到图片元素数量:', images.length); images.forEach((img, index) => { let src = img.getAttribute('src') || ''; console.log('[Baozi] 图片', index, 'src:', src); if (src) { src = src.replace('.baozicdn.com', '.baozimh.com'); pages.push({ index: index, url: src }); } }); const nextBtn = document.querySelector('#next-chapter'); const hasNextPage = nextBtn && (nextBtn.textContent === '下一页' || nextBtn.textContent === '下一頁'); console.log('[Baozi] 提取到', pages.length, '张图片, 有下一页:', hasNextPage); return JSON.stringify({ pages: pages, hasNextPage: hasNextPage, nextPageUrl: hasNextPage ? nextBtn.getAttribute('href') : null }); })();",
          "description": "提取当前页图片列表"
        }
      ]
    },

    "getImageUrl": {
      "description": "获取图片URL（直接返回，已在getPageList中处理域名替换）",
      "actions": [
        {
          "type": "script",
          "code": "(() => { let url = '{{imageUrl}}'; url = url.replace('.baozicdn.com', '.baozimh.com'); return url; })();",
          "description": "返回图片URL（替换CDN域名）"
        }
      ]
    }
  },

  "tabs": [
    {
      "id": "popular",
      "type": "popular",
      "name": "热门",
      "enabled": true,
      "order": 0,
      "requiresLogin": false
    },
    {
      "id": "latest",
      "type": "latest",
      "name": "最新",
      "enabled": true,
      "order": 1,
      "requiresLogin": false
    },
    {
      "id": "filter",
      "type": "filter",
      "name": "筛选",
      "enabled": true,
      "order": 2,
      "requiresLogin": false,
      "filterConfig": {
        "title": "筛选漫画",
        "description": "选择筛选条件",
        "groups": [
          {
            "id": "type",
            "title": "标签",
            "defaultValue": "all"
          },
          {
            "id": "region",
            "title": "地区",
            "defaultValue": "all",
            "options": [
              {"value": "all", "label": "全部"},
              {"value": "cn", "label": "国漫"},
              {"value": "jp", "label": "日本"},
              {"value": "kr", "label": "韩国"},
              {"value": "en", "label": "欧美"}
            ]
          },
          {
            "id": "state",
            "title": "进度",
            "defaultValue": "all",
            "options": [
              {"value": "all", "label": "全部"},
              {"value": "serial", "label": "连载中"},
              {"value": "pub", "label": "已完结"}
            ]
          }
        ]
      }
    }
  ],

  "filters": {
    "type": {
      "name": "标签",
      "key": "type",
      "default": "all",
      "options": [
        {"label": "全部", "value": "all"},
        {"label": "都市", "value": "dushi"},
        {"label": "冒险", "value": "mouxian"},
        {"label": "热血", "value": "rexie"},
        {"label": "恋爱", "value": "lianai"},
        {"label": "耽美", "value": "danmei"},
        {"label": "武侠", "value": "wuxia"},
        {"label": "格斗", "value": "gedou"},
        {"label": "科幻", "value": "kehuan"},
        {"label": "魔幻", "value": "mohuan"},
        {"label": "推理", "value": "tuili"},
        {"label": "玄幻", "value": "xuanhuan"},
        {"label": "日常", "value": "richang"},
        {"label": "生活", "value": "shenghuo"},
        {"label": "搞笑", "value": "gaoxiao"},
        {"label": "校园", "value": "xiaoyuan"},
        {"label": "奇幻", "value": "qihuan"},
        {"label": "萌系", "value": "mengxi"},
        {"label": "穿越", "value": "chuanyue"},
        {"label": "后宫", "value": "hougong"},
        {"label": "战争", "value": "zhanzheng"},
        {"label": "历史", "value": "lishi"},
        {"label": "剧情", "value": "juqing"},
        {"label": "同人", "value": "tongren"},
        {"label": "竞技", "value": "jingji"},
        {"label": "励志", "value": "lizhi"},
        {"label": "治愈", "value": "zhiyu"},
        {"label": "机甲", "value": "jijia"},
        {"label": "纯爱", "value": "chunai"},
        {"label": "美食", "value": "meishi"},
        {"label": "恶搞", "value": "egao"},
        {"label": "虐心", "value": "nuexin"},
        {"label": "动作", "value": "dongzuo"},
        {"label": "惊险", "value": "liangxian"},
        {"label": "唯美", "value": "weimei"},
        {"label": "复仇", "value": "fuchou"},
        {"label": "脑洞", "value": "naodong"},
        {"label": "宫斗", "value": "gongdou"},
        {"label": "运动", "value": "yundong"},
        {"label": "灵异", "value": "lingyi"},
        {"label": "古风", "value": "gufeng"},
        {"label": "权谋", "value": "quanmou"},
        {"label": "节操", "value": "jiecao"},
        {"label": "明星", "value": "mingxing"},
        {"label": "暗黑", "value": "anhei"},
        {"label": "社会", "value": "shehui"},
        {"label": "音乐舞蹈", "value": "yinlewudao"},
        {"label": "悬疑", "value": "xuanyi"},
        {"label": "霸总", "value": "bazong"},
        {"label": "百合", "value": "yuri"},
        {"label": "大女主", "value": "danuzhu"},
        {"label": "少女", "value": "shaonu"},
        {"label": "少年", "value": "shaonian"},
        {"label": "重生", "value": "zhongsheng"},
        {"label": "韩漫", "value": "hanman"},
        {"label": "其它", "value": "qita"}
      ]
    },
    "region": {
      "name": "地区",
      "key": "region",
      "default": "all",
      "options": [
        {"label": "全部", "value": "all"},
        {"label": "国漫", "value": "cn"},
        {"label": "日本", "value": "jp"},
        {"label": "韩国", "value": "kr"},
        {"label": "欧美", "value": "en"}
      ]
    },
    "state": {
      "name": "进度",
      "key": "state",
      "default": "all",
      "options": [
        {"label": "全部", "value": "all"},
        {"label": "连载中", "value": "serial"},
        {"label": "已完结", "value": "pub"}
      ]
    },
    "filter": {
      "name": "标题开头",
      "key": "filter",
      "default": "*",
      "options": [
        {"label": "全部", "value": "*"},
        {"label": "ABCD", "value": "ABCD"},
        {"label": "EFGH", "value": "EFGH"},
        {"label": "IJKL", "value": "IJKL"},
        {"label": "MNOP", "value": "MNOP"},
        {"label": "QRST", "value": "QRST"},
        {"label": "UVW", "value": "UVW"},
        {"label": "XYZ", "value": "XYZ"},
        {"label": "0-9", "value": "0-9"}
      ]
    }
  },

  "imageHeaders": {
    "Referer": "https://cn.baozimh.com/",
    "User-Agent": "Mozilla/5.0 (Linux; Android 13; Pixel 7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Mobile Safari/537.36"
  }
}
