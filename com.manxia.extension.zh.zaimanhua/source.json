{
  "metadata": {
    "id": "com.manxia.extension.zh.zaimanhua",
    "name": "再漫画",
    "type": "manga",
    "version": "3.1.0",
    "language": "zh-CN",
    "baseUrl": "https://manhua.zaimanhua.com",
    "apiUrl": "https://v4api.zaimanhua.com/app/v1",
    "accountApiUrl": "https://account-api.zaimanhua.com/v1",
    "description": "再漫画 - 需要登录才能阅读完整内容",
    "author": "ManXia Team",
    "nsfw": false,
    "tags": ["chinese", "webview", "authenticated"],
    "Internet": false,
    "notes": "部分漫画需要登录才能阅读，请在设置中配置账号密码"
  },

  "capabilities": {
    "urlResolver": true,
    "pagination": true,
    "errorRetry": true,
    "loginSupport": true,
    "credentialLogin": true,
    "jwtToken": true
  },

  "authentication": {
    "type": "jwt",
    "loginUrl": "https://account-api.zaimanhua.com/v1/login/passwd",
    "loginMethod": "POST",
    "tokenStorageKey": "zaimanhua_token",
    "tokenLeeway": 10,
    "loginPayload": {
      "username": "{{username}}",
      "passwd": "{{password_md5}}"
    },
    "passwordEncryption": "md5",
    "tokenExtraction": {
      "type": "json",
      "path": "data.user.token",
      "alternatePath": "data.userInfo.token"
    },
    "tokenValidation": {
      "url": "https://account-api.zaimanhua.com/v1/userInfo/get",
      "method": "GET",
      "successField": "errno",
      "successValue": 0
    },
    "requiresLogin": true,
    "tokenHeader": "Authorization",
    "tokenPrefix": "Bearer "
  },

  "network": {
    "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
    "timeout": 30000,
    "retryCount": 3,
    "retryDelay": 2000,
    "rateLimit": 500,
    "headers": {
      "Referer": "https://manhua.zaimanhua.com/",
      "Content-Type": "application/x-www-form-urlencoded"
    }
  },

  "settings": {
    "username": {
      "type": "text",
      "name": "用户名",
      "description": "再漫画账号用户名",
      "required": true
    },
    "password": {
      "type": "password",
      "name": "密码",
      "description": "再漫画账号密码",
      "required": true
    }
  },

  "tabs": [
    {
      "id": "latest",
      "type": "latest",
      "name": "最新",
      "enabled": true,
      "order": 0,
      "requiresLogin": false
    },
    {
      "id": "favorites",
      "type": "favorites",
      "name": "收藏",
      "enabled": false,  
      "order": 1,
      "requiresLogin": false,
      "icon": "heart",
      "description": "您收藏的漫画"
    }
  ],

  "searchConfig": {
    "types": [
      {
        "id": "search",
        "label": "关键词",
        "placeholder": "输入漫画名称",
        "description": "搜索漫画",
        "isDefault": true
      },
      {
        "id": "searchById",
        "label": "作品ID",
        "placeholder": "输入作品ID（如：84784）",
        "description": "直接访问作品详情页"
      },
      {
        "id": "searchByTag",
        "label": "分类搜索",
        "placeholder": "输入分类ID（如：1、2、3）",
        "description": "按分类筛选漫画"
      }
    ]
  },

  "workflows": {
    "login": {
      "description": "用户登录获取JWT令牌",
      "actions": [
        {
          "type": "http",
          "method": "POST",
          "url": "https://account-api.zaimanhua.com/v1/login/passwd",
          "contentType": "application/x-www-form-urlencoded",
          "body": "username={{username}}&passwd={{password_md5}}",
          "description": "发送登录请求",
          "responseType": "json",
          "extract": {
            "token": "data.user.token || data.userInfo.token"
          },
          "onSuccess": {
            "saveToken": true,
            "tokenKey": "zaimanhua_token"
          }
        }
      ]
    },

    "favorites": {
      "description": "获取用户收藏",
      "supportsPagination": true,
      "requiresLogin": true,
      "actions": [
        {
          "type": "navigate",
          "url": "https://i.zaimanhua.com/subscribe",
          "timeout": 15000,
          "description": "导航到收藏页面"
        },
        {
          "type": "wait",
          "condition": "time",
          "duration": 3000,
          "description": "等待3秒让页面加载"
        },
        {
          "type": "script",
          "code": "(() => { const page = parseInt('{{page}}') || 1; console.log('[Zaimanhua] 收藏请求页码: ' + page); if (page > 1) { const pageButtons = document.querySelectorAll('.ant-pagination-item'); console.log('[Zaimanhua] 找到分页按钮数量: ' + pageButtons.length); let clicked = false; pageButtons.forEach(btn => { const pageNum = btn.getAttribute('title') || btn.textContent.trim(); if (pageNum === page.toString()) { btn.click(); clicked = true; console.log('[Zaimanhua] 点击了第' + page + '页按钮'); } }); if (!clicked) { console.log('[Zaimanhua] 未找到第' + page + '页按钮'); } return JSON.stringify({ clicked: clicked, page: page }); } return JSON.stringify({ clicked: false, page: 1 }); })();",
          "description": "如果不是第一页，点击对应的分页按钮"
        },
        {
          "type": "wait",
          "condition": "time",
          "duration": 2000,
          "description": "等待2秒让内容加载"
        },
        {
          "type": "script",
          "code": "(async () => { try { const page = parseInt('{{page}}') || 1; const response = await fetch('https://i.zaimanhua.com/api/app/v1/comic/sub/list?status=&firstLetter=&page=' + page + '&size=20', { credentials: 'include' }); const data = await response.json(); if (data.errno === 0 && data.data && data.data.subList) { const mangas = data.data.subList.map(item => ({ id: String(item.id), title: item.title, cover: item.cover, author: '', status: item.status === '连载中' ? '连载中' : '已完结', latestChapter: item.last_update_chapter_name || '' })); console.log('[Zaimanhua] 收藏列表: ' + mangas.length + '个'); return JSON.stringify(mangas); } else { console.log('[Zaimanhua] API返回错误: ' + data.errmsg); return JSON.stringify([]); } } catch (e) { console.error('[Zaimanhua] 获取收藏失败: ' + e); return JSON.stringify([]); } })();",
          "description": "通过API获取收藏列表"
        }
      ]
    },

    "latest": {
      "description": "获取最新更新",
      "supportsPagination": true,
      "actions": [
        {
          "type": "navigate",
          "url": "https://manhua.zaimanhua.com/update",
          "timeout": 15000,
          "description": "导航到最新更新页面"
        },
        {
          "type": "wait",
          "condition": "time",
          "duration": 3000,
          "description": "等待3秒让页面加载"
        },
        {
          "type": "script",
          "code": "(() => { const page = parseInt('{{page}}') || 1; console.log('[Zaimanhua] 请求页码: ' + page); if (page > 1) { const pageButtons = document.querySelectorAll('li.number'); console.log('[Zaimanhua] 找到分页按钮数量: ' + pageButtons.length); let clicked = false; pageButtons.forEach(btn => { if (btn.textContent.trim() === page.toString()) { btn.click(); clicked = true; console.log('[Zaimanhua] 点击了第' + page + '页按钮'); } }); if (!clicked) { console.log('[Zaimanhua] 未找到第' + page + '页按钮'); } return JSON.stringify({ clicked: clicked, page: page }); } return JSON.stringify({ clicked: false, page: 1 }); })();",
          "description": "如果不是第一页，点击对应的分页按钮"
        },
        {
          "type": "wait",
          "condition": "time",
          "duration": 2000,
          "description": "等待2秒让内容加载"
        },
        {
          "type": "script",
          "code": "(() => { const mangas = []; const items = document.querySelectorAll('li:has(a.comic_img)'); console.log('[Zaimanhua] 找到漫画项数量: ' + items.length); items.forEach((item) => { const linkEl = item.querySelector('a.comic_img'); const imgEl = item.querySelector('img.lazy, img'); const titleEl = item.querySelector('h3 a'); const detSpan = item.querySelector('span.comic_list_det'); if (linkEl && titleEl) { const href = linkEl.getAttribute('href') || ''; const match = href.match(/\\/details\\/(\\d+)/); const mangaId = match ? match[1] : ''; const title = titleEl.textContent?.trim() || ''; const cover = imgEl?.getAttribute('src') || ''; let author = ''; let genre = ''; let status = ''; let latestChapter = ''; let updateTime = ''; if (detSpan) { const allPs = detSpan.querySelectorAll('p'); allPs.forEach(p => { const text = p.textContent?.trim() || ''; if (text.startsWith('作者：')) author = text.replace('作者：', '').trim(); else if (text.startsWith('类型：')) genre = text.replace('类型：', '').trim(); else if (text.startsWith('状态：')) status = text.replace('状态：', '').trim(); else if (text.startsWith('最新：')) latestChapter = text.replace('最新：', '').trim(); else if (p.classList.contains('con_data')) updateTime = text; }); } if (mangaId) { mangas.push({ id: mangaId, title: title, cover: cover, author: author, genre: genre, status: status, latestChapter: latestChapter, updateTime: updateTime }); } } }); console.log('[Zaimanhua] 提取漫画数量: ' + mangas.length); return JSON.stringify(mangas); })();",
          "description": "提取最新漫画列表"
        }
      ]
    },

    "search": {
      "description": "搜索漫画",
      "supportsPagination": true,
      "actions": [
        {
          "type": "navigate",
          "url": "https://manhua.zaimanhua.com/dynamic/{{query}}",
          "timeout": 15000,
          "description": "导航到搜索结果页"
        },
        {
          "type": "wait",
          "condition": "time",
          "duration": 3000,
          "description": "等待3秒让页面加载"
        },
        {
          "type": "script",
          "code": "(() => { const page = parseInt('{{page}}') || 1; console.log('[Zaimanhua] 搜索请求页码: ' + page); if (page > 1) { const pageButtons = document.querySelectorAll('ul.el-pager li.number'); console.log('[Zaimanhua] 找到分页按钮数量: ' + pageButtons.length); let clicked = false; pageButtons.forEach(btn => { if (btn.textContent.trim() === page.toString()) { btn.click(); clicked = true; console.log('[Zaimanhua] 点击了第' + page + '页按钮'); } }); if (!clicked) { console.log('[Zaimanhua] 未找到第' + page + '页按钮'); } return JSON.stringify({ clicked: clicked, page: page }); } return JSON.stringify({ clicked: false, page: 1 }); })();",
          "description": "如果不是第一页，点击对应的分页按钮"
        },
        {
          "type": "wait",
          "condition": "time",
          "duration": 2000,
          "description": "等待2秒让内容加载"
        },
        {
          "type": "script",
          "code": "(() => { const mangas = []; const items = document.querySelectorAll('li:has(a[href*=\"/details/\"])'); console.log('[Zaimanhua] 搜索结果数量: ' + items.length); items.forEach((item) => { const linkEl = item.querySelector('a[href*=\"/details/\"]'); const imgEl = item.querySelector('img'); const titleEl = item.querySelector('p.title a'); if (linkEl) { const href = linkEl.getAttribute('href') || ''; const match = href.match(/\\/details\\/(\\d+)/); const mangaId = match ? match[1] : ''; const title = titleEl?.getAttribute('title') || titleEl?.textContent?.trim() || ''; const cover = imgEl?.getAttribute('src') || ''; const authorEl = item.querySelector('p.auth'); const author = authorEl?.textContent?.trim() || ''; const newPageEl = item.querySelector('p.newPage'); const latestChapter = newPageEl?.textContent?.replace('最新：', '').trim() || ''; const overEl = item.querySelector('p.over_comic'); const status = overEl ? '完结' : '连载中'; if (mangaId) { mangas.push({ id: mangaId, title: title, cover: cover, author: author, status: status, latestChapter: latestChapter }); } } }); console.log('[Zaimanhua] 提取漫画数量: ' + mangas.length); return JSON.stringify(mangas); })();",
          "description": "提取搜索结果"
        }
      ]
    },

    "getMangaDetail": {
      "description": "获取漫画详情",
      "actions": [
        {
          "type": "navigate",
          "url": "https://manhua.zaimanhua.com/details/{{mangaId}}",
          "timeout": 15000,
          "description": "导航到漫画详情页"
        },
        {
          "type": "wait",
          "condition": "time",
          "duration": 3000,
          "description": "等待3秒让页面加载"
        },
        {
          "type": "script",
          "code": "(() => { const titleEl = document.querySelector('h1 a, h1'); const title = titleEl?.textContent?.trim() || ''; const imgs = document.querySelectorAll('img'); let cover = ''; for (let i = 0; i < imgs.length; i++) { const src = imgs[i].getAttribute('src') || ''; if (src.includes('images.zaimanhua.com') && !src.includes('base64')) { cover = src; break; } } const allPs = document.querySelectorAll('p'); let author = ''; let status = 0; let genres = []; allPs.forEach((p, idx) => { const text = p.textContent?.trim() || ''; if (idx >= 5 && idx <= 10 && text.length < 20 && !text.includes('更新')) { if (idx === 5) author = text; else if (text === '已完结' || text === '完结') status = 2; else if (text === '连载中' || text === '连载') status = 1; else if (text.length > 0 && text.length < 10) genres.push(text); } }); const genre = genres.join(','); console.log('[Zaimanhua] 详情: title=' + title + ', author=' + author + ', status=' + status); return JSON.stringify({ title, cover, author, status, description: '', genre }); })();",
          "description": "提取漫画详情"
        }
      ]
    },

    "getChapterList": {
      "description": "获取章节列表",
      "actions": [
        {
          "type": "navigate",
          "url": "https://manhua.zaimanhua.com/details/{{mangaId}}",
          "timeout": 15000,
          "description": "导航到漫画详情页"
        },
        {
          "type": "wait",
          "condition": "time",
          "duration": 3000,
          "description": "等待3秒让页面加载"
        },
        {
          "type": "script",
          "code": "(() => { const chapters = []; const chapterEls = document.querySelectorAll('li a[href*=\"/view/\"]'); chapterEls.forEach(el => { const href = el.getAttribute('href') || ''; const match = href.match(/\\/view\\/([^\\/]+)\\/(\\d+)\\/(\\d+)/); if (match) { const slug = match[1]; const mangaId = match[2]; const chapterId = match[3]; const titleEl = el.querySelector('span.list_con_zj'); const title = titleEl?.textContent?.trim() || el.textContent?.trim() || ''; chapters.push({ id: slug + '/' + mangaId + '/' + chapterId, title: title, url: href }); } }); return JSON.stringify(chapters); })();",
          "description": "提取章节列表（ID格式：slug/mangaId/chapterId）"
        }
      ]
    },

    "getPageList": {
      "description": "获取章节图片列表（WebView方式）",
      "actions": [
        {
          "type": "navigate",
          "url": "https://manhua.zaimanhua.com/view/{{chapterId}}",
          "timeout": 20000,
          "description": "导航到章节阅读页（chapterId格式：slug/mangaId/chapterId）"
        },
        {
          "type": "wait",
          "condition": "time",
          "duration": 3000,
          "description": "等待3秒让页面加载"
        },
        {
          "type": "script",
          "code": "(() => { const switchBtn = document.querySelector('#qiehuan_txt'); if (switchBtn && switchBtn.textContent.includes('上下滚动')) { switchBtn.click(); console.log('[Zaimanhua] 已点击切换按钮'); } else { console.log('[Zaimanhua] 未找到切换按钮或已是滚动模式'); } return JSON.stringify({ switched: true }); })();",
          "description": "切换到上下滚动阅读模式"
        },
        {
          "type": "wait",
          "condition": "time",
          "duration": 3000,
          "description": "等待3秒让图片加载"
        },
        {
          "type": "script",
          "code": "(() => { const pages = []; const images = document.querySelectorAll('img[src*=\"images.zaimanhua\"]'); console.log('[Zaimanhua] 找到图片数量: ' + images.length); images.forEach((img, index) => { const src = img.getAttribute('src') || ''; if (src && !src.includes('txImg.png') && !src.includes('loading')) { pages.push({ index: index, url: src }); } }); console.log('[Zaimanhua] 有效图片数量: ' + pages.length); return JSON.stringify({ pages: pages, hasNextPage: false, nextPageUrl: null }); })();",
          "description": "提取图片列表"
        }
      ]
    },

    "getImageUrl": {
      "description": "获取图片URL（直接返回）",
      "actions": [
        {
          "type": "script",
          "code": "(() => { return '{{imageUrl}}'; })();",
          "description": "返回图片URL"
        }
      ]
    },

    "directSearch": {
      "description": "直达搜索 - 提取作品ID并返回",
      "actions": [
        {
          "type": "script",
          "code": "(function() { const query = '{{query}}'; const mangaId = query.trim(); console.log('[Zaimanhua DirectSearch] 提取mangaId: ' + mangaId); const result = { type: 'detail', manga: { id: mangaId, title: '', url: '{{baseUrl}}/details/' + mangaId, cover: '' }, error: null }; return JSON.stringify(result); })();",
          "description": "提取作品ID并返回，后续由getMangaDetail工作流处理"
        }
      ]
    },

    "searchByTag": {
      "description": "按分类/标签筛选漫画",
      "supportsPagination": true,
      "actions": [
        {
          "type": "api",
          "method": "GET",
          "url": "https://v4api.zaimanhua.com/app/v1/comic/filter/list",
          "params": {
            "tag_id": "{{tagId}}",
            "page": "{{page}}",
            "size": "20"
          },
          "headers": {
            "Authorization": "Bearer {{token}}"
          },
          "extract": {
            "type": "json",
            "path": "data.list",
            "fields": {
              "id": "comic_id",
              "title": "name",
              "cover": "cover",
              "author": "author"
            }
          },
          "pagination": {
            "enabled": true,
            "type": "page",
            "pageParam": "page"
          }
        }
      ]
    }
  },

  "changelog": [
    {
      "version": "3.2.0",
      "date": "2026-01-09",
      "changes": [
        "添加收藏标签页功能",
        "通过API获取用户收藏列表",
        "支持收藏列表分页"
      ]
    },
    {
      "version": "3.1.0",
      "date": "2026-01-09",
      "changes": [
        "添加登录功能，支持JWT Token认证",
        "添加用户名密码设置项",
        "添加login工作流",
        "密码使用MD5加密传输",
        "Token自动保存和验证"
      ]
    },
    {
      "version": "3.0.0",
      "date": "2026-01-09",
      "changes": [
        "完全重写，采用禁漫天堂格式",
        "基于实际DOM结构优化所有选择器",
        "支持最新更新、搜索、漫画详情、章节列表、图片获取",
        "自动切换到上下滚动阅读模式获取所有图片",
        "使用PC版UA访问桌面版网站"
      ]
    }
  ]
}
